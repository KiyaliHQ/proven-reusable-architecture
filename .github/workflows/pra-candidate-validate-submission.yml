name: PRA Candidate - Validate Submission

on:
  pull_request:
    types: [opened, synchronize]
    paths:
      - '**/*'  # Monitor ALL files to detect framework modifications

permissions:
  contents: read
  pull-requests: write
  statuses: write

jobs:
  check-framework-protection:
    name: Check Framework Protection
    runs-on: ubuntu-latest
    outputs:
      framework_protection_passed: ${{ steps.check-membership.outputs.passed }}
      non_content_files: ${{ steps.detect-files.outputs.non_content_files }}
      has_non_content_changes: ${{ steps.detect-files.outputs.has_non_content_changes }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect modified files
        id: detect-files
        run: |
          # Get all modified files
          git fetch origin ${{ github.base_ref }}
          MODIFIED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)

          # Separate content/ vs non-content/ files
          NON_CONTENT_FILES=()
          CONTENT_FILES=()

          while IFS= read -r file; do
            if [[ "$file" == content/* ]]; then
              CONTENT_FILES+=("$file")
            else
              NON_CONTENT_FILES+=("$file")
            fi
          done <<< "$MODIFIED_FILES"

          # Check if there are non-content modifications
          if [ ${#NON_CONTENT_FILES[@]} -gt 0 ]; then
            echo "has_non_content_changes=true" >> $GITHUB_OUTPUT
            # Convert array to JSON
            NON_CONTENT_JSON=$(printf '%s\n' "${NON_CONTENT_FILES[@]}" | jq -R -s -c 'split("\n") | map(select(length > 0))')
            echo "non_content_files=$NON_CONTENT_JSON" >> $GITHUB_OUTPUT

            echo "‚ùå Non-content files modified:"
            printf '%s\n' "${NON_CONTENT_FILES[@]}"
          else
            echo "has_non_content_changes=false" >> $GITHUB_OUTPUT
            echo "non_content_files=[]" >> $GITHUB_OUTPUT
            echo "‚úÖ Only content/ files modified"
          fi

      - name: Check PR author membership in pra-development-team
        id: check-membership
        if: steps.detect-files.outputs.has_non_content_changes == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const author = context.payload.pull_request.user.login;
            console.log('üîç Checking membership for user: ' + author);

            // Hardcoded list of pra-development-team members (temporary workaround for API permissions)
            // TODO: Replace with proper PAT-based team membership check
            const allowedMembers = [
              'FofanaAmara',
              // Add other team members here
            ];

            // Check hardcoded list first
            if (allowedMembers.includes(author)) {
              console.log('‚úÖ User ' + author + ' is in allowed members list');
              core.setOutput('passed', 'true');
              return;
            }

            // Try API check as fallback (requires PAT with read:org scope)
            try {
              console.log('üì° Calling GitHub API to check team membership...');
              const membership = await github.rest.teams.getMembershipForUserInOrg({
                org: 'KiyaliHQ',
                team_slug: 'pra-development-team',
                username: author
              });

              console.log('üìä Membership response:', JSON.stringify(membership.data, null, 2));

              if (membership.data.state === 'active') {
                console.log('‚úÖ User ' + author + ' is member of pra-development-team (API check)');
                core.setOutput('passed', 'true');
                return;
              } else {
                console.log('‚ö†Ô∏è User ' + author + ' membership state is: ' + membership.data.state);
              }
            } catch (error) {
              console.error('‚ö†Ô∏è API check failed (expected if using default GITHUB_TOKEN):', error.message);
            }

            // Not a member - fail the check
            console.log('‚ùå User ' + author + ' is not authorized to modify framework files');
            core.setOutput('passed', 'false');
            core.setFailed('Framework modifications are restricted to pra-development-team members');

      - name: Set success if no non-content changes
        if: steps.detect-files.outputs.has_non_content_changes == 'false'
        run: |
          echo "passed=true" >> $GITHUB_OUTPUT

  detect-and-validate-pra:
    name: Detect & Validate PRA Candidate
    needs: check-framework-protection
    if: needs.check-framework-protection.outputs.framework_protection_passed == 'true'
    runs-on: ubuntu-latest
    outputs:
      validation_passed: ${{ steps.validate.outputs.validation_passed }}
      scope: ${{ steps.extract-meta.outputs.scope }}
      domain: ${{ steps.extract-meta.outputs.domain }}
      category: ${{ steps.extract-meta.outputs.category }}
      proven_count: ${{ steps.extract-meta.outputs.proven_count }}
      pra_title: ${{ steps.extract-meta.outputs.pra_title }}
      new_pra_candidates: ${{ steps.detect.outputs.new_pra_candidates }}
      validation_errors: ${{ steps.validate.outputs.errors }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect new PRA candidate files
        id: detect
        run: |
          # Get all modified .md files in content/pras-*/
          git fetch origin ${{ github.base_ref }}
          MODIFIED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep "content/pras-.*\.md$" || true)

          NEW_PRA_CANDIDATES=()

          while IFS= read -r file; do
            # Skip if empty
            [ -z "$file" ] && continue

            # Check if file is in /candidate/ path
            if [[ "$file" == */candidate/* ]]; then
              # Check if file exists in base branch (new file)
              if ! git cat-file -e origin/${{ github.base_ref }}:"$file" 2>/dev/null; then
                echo "‚úÖ NEW PRA Candidate detected: $file"
                NEW_PRA_CANDIDATES+=("$file")
              fi
            fi
          done <<< "$MODIFIED_FILES"

          # Output as JSON array
          if [ ${#NEW_PRA_CANDIDATES[@]} -gt 0 ]; then
            NEW_PRA_JSON=$(printf '%s\n' "${NEW_PRA_CANDIDATES[@]}" | jq -R -s -c 'split("\n") | map(select(length > 0))')
            echo "new_pra_candidates=$NEW_PRA_JSON" >> $GITHUB_OUTPUT
            echo "has_new_candidates=true" >> $GITHUB_OUTPUT
          else
            echo "new_pra_candidates=[]" >> $GITHUB_OUTPUT
            echo "has_new_candidates=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è  No new PRA candidates detected in this PR"
          fi

      - name: Setup Node.js
        if: steps.detect.outputs.has_new_candidates == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        if: steps.detect.outputs.has_new_candidates == 'true'
        run: npm install -g gray-matter js-yaml

      - name: Extract metadata
        if: steps.detect.outputs.has_new_candidates == 'true'
        id: extract-meta
        run: |
          # Get first PRA candidate file (for now, process only first one)
          NEW_PRA_CANDIDATES='${{ steps.detect.outputs.new_pra_candidates }}'
          FIRST_PRA=$(echo "$NEW_PRA_CANDIDATES" | jq -r '.[0]')

          echo "Processing: $FIRST_PRA"

          # Extract scope/status/category from path
          # Example: content/pras-fr/bank-wide/candidate/tech/api-gateway.md
          IFS='/' read -ra PATH_PARTS <<< "$FIRST_PRA"

          LANG=$(echo "${PATH_PARTS[1]}" | cut -d'-' -f2)  # fr or en
          SCOPE="${PATH_PARTS[2]}"  # bank-wide or domain-wide

          if [ "$SCOPE" == "domain-wide" ]; then
            DOMAIN="${PATH_PARTS[3]}"  # particuliers, entreprises, gestion-patrimoine
            STATUS="${PATH_PARTS[4]}"  # candidate
            CATEGORY="${PATH_PARTS[5]}"  # tech, integration, etc.
          else
            DOMAIN=""
            STATUS="${PATH_PARTS[3]}"  # candidate
            CATEGORY="${PATH_PARTS[4]}"  # tech, integration, etc.
          fi

          echo "scope=$SCOPE" >> $GITHUB_OUTPUT
          echo "domain=$DOMAIN" >> $GITHUB_OUTPUT
          echo "status=$STATUS" >> $GITHUB_OUTPUT
          echo "category=$CATEGORY" >> $GITHUB_OUTPUT

          # Extract metadata using gray-matter
          node -e "
            const fs = require('fs');
            const matter = require('gray-matter');

            const content = fs.readFileSync('$FIRST_PRA', 'utf8');
            const { data } = matter(content);

            const praData = data.pra || {};
            const provenCount = (praData.proven_in_use || []).length;
            const praTitle = praData.name || data.title || 'Unknown';

            console.log('pra_title=' + praTitle);
            console.log('proven_count=' + provenCount);
          " >> $GITHUB_OUTPUT

      - name: Validate PRA structure
        if: steps.detect.outputs.has_new_candidates == 'true'
        id: validate
        run: |
          NEW_PRA_CANDIDATES='${{ steps.detect.outputs.new_pra_candidates }}'
          FIRST_PRA=$(echo "$NEW_PRA_CANDIDATES" | jq -r '.[0]')

          ERRORS=()

          # 1. Validate proven-in-use count (1+ for candidate)
          PROVEN_COUNT='${{ steps.extract-meta.outputs.proven_count }}'
          if [ "$PROVEN_COUNT" -lt 1 ]; then
            ERRORS+=("Missing proven-in-use: At least 1 proven-in-use required for candidate status")
          fi

          # 2. Validate required sections
          REQUIRED_SECTIONS=("Overview" "Context" "Architecture" "ADR" "Example")
          for section in "${REQUIRED_SECTIONS[@]}"; do
            if ! grep -q "^##\s*${section}" "$FIRST_PRA"; then
              ERRORS+=("Missing section: '$section' section not found")
            fi
          done

          # 3. Validate bilingual (FR + EN)
          # Convert pras-fr to pras-en or vice versa
          if [[ "$FIRST_PRA" == *"pras-fr"* ]]; then
            COUNTERPART=$(echo "$FIRST_PRA" | sed 's/pras-fr/pras-en/')
          else
            COUNTERPART=$(echo "$FIRST_PRA" | sed 's/pras-en/pras-fr/')
          fi

          if [ ! -f "$COUNTERPART" ]; then
            ERRORS+=("Bilingual requirement: Missing translation at $COUNTERPART")
          fi

          # Set validation result
          if [ ${#ERRORS[@]} -eq 0 ]; then
            echo "validation_passed=true" >> $GITHUB_OUTPUT
            echo "errors=[]" >> $GITHUB_OUTPUT
            echo "‚úÖ Validation passed"
          else
            echo "validation_passed=false" >> $GITHUB_OUTPUT
            ERRORS_JSON=$(printf '%s\n' "${ERRORS[@]}" | jq -R -s -c 'split("\n") | map(select(length > 0))')
            echo "errors=$ERRORS_JSON" >> $GITHUB_OUTPUT
            echo "‚ùå Validation failed"
            printf '%s\n' "${ERRORS[@]}"
          fi

  assign-reviewers:
    name: Assign Governance Reviewers
    needs: detect-and-validate-pra
    if: needs.detect-and-validate-pra.outputs.validation_passed == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Assign reviewers based on scope
        uses: actions/github-script@v7
        with:
          script: |
            const scope = '${{ needs.detect-and-validate-pra.outputs.scope }}';
            const domain = '${{ needs.detect-and-validate-pra.outputs.domain }}';

            let team;
            if (scope === 'bank-wide') {
              team = 'comite-architectes-experts';
            } else if (scope === 'domain-wide') {
              if (domain === 'particuliers') {
                team = 'comite-gov-particuliers';
              } else if (domain === 'entreprises') {
                team = 'comite-gov-entreprises';
              } else if (domain === 'gestion-patrimoine') {
                team = 'comite-gov-patrimoine';
              }
            }

            console.log('Assigning reviewers: @KiyaliHQ/' + team);

            await github.rest.pulls.requestReviewers({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number,
              team_reviewers: [team]
            });

  post-comment:
    name: Post Validation Result
    needs: [check-framework-protection, detect-and-validate-pra]
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: Post framework protection error
        if: needs.check-framework-protection.outputs.framework_protection_passed == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const nonContentFiles = JSON.parse('${{ needs.check-framework-protection.outputs.non_content_files }}');
            const fileList = nonContentFiles.map(f => '- `' + f + '`').join('\n');
            const team = '@' + 'KiyaliHQ/pra-development-team';

            const comment = '## üö´ Framework Modification Blocked\n\n' +
              'Your PR contains modifications to files outside the `content/` directory. Only members of the **' + team + '** can modify framework files.\n\n' +
              '### ‚ùå Blocked Files\n' + fileList + '\n\n' +
              '### üìÇ Allowed Modifications\n' +
              'Contributors can only modify files in:\n' +
              '- `content/pras-fr/` - French PRAs\n' +
              '- `content/pras-en/` - English PRAs\n' +
              '- `content/guides/` - Registry guides\n\n' +
              '### üîß Framework Files (Restricted)\n' +
              'The following directories are restricted to the PRA Development Team:\n' +
              '- `site/` - Next.js application\n' +
              '- `.github/workflows/` - GitHub workflows\n' +
              '- `docs/` - Root documentation\n' +
              '- `scripts/` - Utility scripts\n' +
              '- `templates/` - PRA templates\n\n' +
              '### üí° Need to Modify Framework?\n' +
              'If you have a legitimate reason to modify framework files:\n' +
              '1. Contact **' + team + '** on Teams (#pra-registry)\n' +
              '2. Explain your use case\n' +
              '3. They will either make the change or grant temporary access\n\n' +
              '### ‚úÖ Next Steps\n' +
              '1. Remove modifications to framework files from this PR\n' +
              '2. Keep only changes to files in `content/`\n' +
              '3. Push your changes - the validation will re-run automatically';

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Post validation success
        if: needs.detect-and-validate-pra.outputs.validation_passed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const scope = '${{ needs.detect-and-validate-pra.outputs.scope }}';
            const category = '${{ needs.detect-and-validate-pra.outputs.category }}';
            const praTitle = '${{ needs.detect-and-validate-pra.outputs.pra_title }}';
            const provenCount = '${{ needs.detect-and-validate-pra.outputs.proven_count }}';

            const scopeCapitalized = scope.charAt(0).toUpperCase() + scope.slice(1);
            const categoryCapitalized = category.charAt(0).toUpperCase() + category.slice(1);

            let teamName = '';
            if (scope === 'bank-wide') {
              teamName = 'Expert Architects Committee';
            } else {
              teamName = scopeCapitalized + ' Governance Committee';
            }

            const comment = '## üéâ New PRA Candidate Submission\n\n' +
              'Your PRA has been successfully submitted for approval!\n\n' +
              '### üìã Details Detected\n' +
              '- **Scope**: ' + scopeCapitalized + '\n' +
              '- **Category**: ' + categoryCapitalized + '\n' +
              '- **Status**: Candidate\n' +
              '- **Title**: ' + praTitle + '\n' +
              '- **Proven-in-use**: ' + provenCount + ' implementation(s) documented\n\n' +
              '### ‚úÖ Automatic Validation\n' +
              '- [x] Complete metadata (YAML frontmatter)\n' +
              '- [x] All required sections present (Overview, Context, Architecture, ADRs, Examples)\n' +
              '- [x] ' + provenCount + '+ proven-in-use documented\n' +
              '- [x] Bilingual (FR + EN files found)\n\n' +
              '### üë• Governance Review Process\n' +
              'Your PRA will be reviewed by the **' + teamName + '**.\n' +
              '- **Approvals required**: 2 members\n' +
              '- **Timeline**: 2-4 weeks\n\n' +
              '### üìä Current Status\n' +
              '- [ ] Awaiting committee meeting (0/2) ‚è≥\n\n' +
              '### üìö Next Steps\n' +
              '1. **Committee Meeting** üìÖ - You will be invited to present your PRA to the governance committee\n' +
              '2. **Presentation** üé§ - Present the context, architecture, benefits, and trade-offs\n' +
              '3. **Discussion** üí¨ - Committee members will ask questions and provide feedback\n' +
              '4. **Validation** ‚úÖ - Committee validates or requests changes\n' +
              '5. **GitHub Reviews** - After the meeting, reviewers will approve on GitHub (2 approvals needed)\n' +
              '6. **Merge** - Once 2 approvals received, your PR will be merged\n' +
              '7. **Publication** - Your PRA will be published with **Candidate** status\n\n' +
              '### üîî What to Expect\n' +
              '- You will receive a calendar invite for the committee meeting\n' +
              '- Prepare a short presentation (10-15 minutes) covering:\n' +
              '  - Problem statement and context\n' +
              '  - Proposed architecture\n' +
              '  - Proven implementations (proven-in-use)\n' +
              '  - Trade-offs and alternatives considered\n' +
              '- The committee will provide constructive feedback\n' +
              '- After the meeting, reviewers will update this PR with their decision\n\n' +
              'Thank you for your contribution! üöÄ';

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Post validation failure
        if: needs.detect-and-validate-pra.result == 'success' && needs.detect-and-validate-pra.outputs.validation_passed == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const errors = JSON.parse('${{ needs.detect-and-validate-pra.outputs.validation_errors }}');
            const errorList = errors.map(e => '- [ ] ' + e).join('\n');

            const comment = '## ‚ùå PRA Validation Failed\n\n' +
              'Your PRA submission has some issues that need to be fixed.\n\n' +
              '### üîç Validation Errors\n' +
              errorList + '\n\n' +
              '### üõ†Ô∏è How to Fix\n' +
              'Please address the validation errors listed above. Common fixes:\n' +
              '1. Add at least 1 proven-in-use implementation in the `pra.proven_in_use` array\n' +
              '2. Add any missing sections (Overview, Context, Architecture, ADRs, Examples)\n' +
              '3. Create the translation version (FR or EN) if missing\n\n' +
              '### üìö Resources\n' +
              '- [PRA Template](../../templates/pra-template.md)\n' +
              '- [Contributing Guide](../content/guides/en/06-contributing.md)\n\n' +
              'Once fixed, push your changes and the validation will re-run automatically.';

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
