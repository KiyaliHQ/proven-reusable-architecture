name: Auto Label PR

# Workflow for automatically labeling PRs based on changes
# Runs on: pull_request (opened)
#
# Detects and labels:
# - Scope: domaine vs bank-wide
# - Domaine: particuliers, entreprises, gestion-patrimoine (if applicable)
# - Category: tech, integration, security, business
# - Change type: nouveau-pra, update, promotion, deprecation, status-change

on:
  pull_request:
    types: [opened, reopened]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  auto-label:
    name: Auto Label Based on Changes
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Get full history for comparison

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          npm install gray-matter

      - name: Get changed PRA files
        id: changed-files
        uses: tj-actions/changed-files@v41
        with:
          files: |
            site/content/**/registre/**/*.md
            site/content/**/registre/**/*.mdx
          files_ignore: |
            site/content/**/registre/index.md
            site/content/**/registre/guides/**

      - name: Detect changes and generate labels
        if: steps.changed-files.outputs.any_changed == 'true'
        id: detect
        run: |
          echo "Analyzing changed files..."

          ALL_LABELS=""

          for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
            echo ""
            echo "Analyzing: $file"

            # Check if file exists (not deleted)
            if [ -f "$file" ]; then
              # Get base file path (for comparison)
              BASE_FILE=""
              if git show origin/${{ github.base_ref }}:$file > /dev/null 2>&1; then
                BASE_FILE="/tmp/base_$(basename "$file")"
                git show origin/${{ github.base_ref }}:$file > "$BASE_FILE"
              fi

              # Detect changes
              if [ -n "$BASE_FILE" ]; then
                DETECTION=$(node scripts/detect-pra-changes.js "$file" "$BASE_FILE")
              else
                DETECTION=$(node scripts/detect-pra-changes.js "$file")
              fi

              echo "Detection result:"
              echo "$DETECTION"

              # Extract labels from JSON
              LABELS=$(echo "$DETECTION" | jq -r '.labels[]' 2>/dev/null || echo "")

              # Append to all labels
              if [ -n "$LABELS" ]; then
                ALL_LABELS="$ALL_LABELS $LABELS"
              fi

              # Cleanup
              [ -f "$BASE_FILE" ] && rm "$BASE_FILE"
            fi
          done

          # Remove duplicates and format
          UNIQUE_LABELS=$(echo "$ALL_LABELS" | tr ' ' '\n' | sort -u | tr '\n' ' ')
          echo "labels=$UNIQUE_LABELS" >> $GITHUB_OUTPUT

          echo ""
          echo "Labels to apply: $UNIQUE_LABELS"

      - name: Apply labels
        if: steps.detect.outputs.labels != ''
        uses: actions/github-script@v7
        with:
          script: |
            const labels = '${{ steps.detect.outputs.labels }}'.trim().split(/\s+/).filter(Boolean);

            if (labels.length > 0) {
              console.log('Applying labels:', labels);

              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: labels
              });

              console.log('‚úÖ Labels applied successfully');
            } else {
              console.log('‚ÑπÔ∏è  No labels to apply');
            }

      - name: Add comment with detection info
        if: steps.detect.outputs.labels != ''
        uses: actions/github-script@v7
        with:
          script: |
            const labels = '${{ steps.detect.outputs.labels }}'.trim().split(/\s+/).filter(Boolean);

            // Extract scope, domaine, category, type
            const scope = labels.find(l => l.startsWith('scope:'))?.replace('scope:', '') || 'unknown';
            const domaine = labels.find(l => l.startsWith('domaine:'))?.replace('domaine:', '') || 'N/A';
            const category = labels.find(l => l.startsWith('category:'))?.replace('category:', '') || 'unknown';
            const type = labels.find(l => l.startsWith('type:'))?.replace('type:', '') || 'unknown';

            let message = '## üè∑Ô∏è Automatic Label Detection\n\n';
            message += '| Property | Value |\n';
            message += '|----------|-------|\n';
            message += `| **Scope** | \`${scope}\` |\n`;

            if (domaine !== 'N/A') {
              message += `| **Domaine** | \`${domaine}\` |\n`;
            }

            message += `| **Category** | \`${category}\` |\n`;
            message += `| **Change Type** | \`${type}\` |\n\n`;

            // Add specific guidance based on type
            if (type === 'nouveau-pra') {
              message += '### üìã New PRA Submission\n\n';
              message += 'This PR introduces a new PRA. Please ensure:\n';
              message += '- [ ] All required sections are complete\n';
              message += '- [ ] At least 1 proven-in-use is documented\n';
              message += '- [ ] ADRs are included with justifications\n';
              message += '- [ ] Code examples are provided\n\n';
            } else if (type === 'promotion') {
              message += '### üöÄ PRA Promotion\n\n';
              message += 'This PR promotes a domain PRA to bank-wide. Requirements:\n';
              message += '- [ ] 3+ proven-in-use from different domains/teams\n';
              message += '- [ ] Multi-domain applicability demonstrated\n';
              message += '- [ ] Documentation enriched with multi-context learnings\n\n';
              message += '**‚è±Ô∏è Expected timeline:** 4-8 weeks for review\n\n';
            } else if (type === 'deprecation') {
              message += '### üìõ PRA Deprecation\n\n';
              message += 'This PR deprecates a PRA. Please ensure:\n';
              message += '- [ ] Alternative PRA is mentioned\n';
              message += '- [ ] Migration plan is provided\n';
              message += '- [ ] Affected teams are identified\n\n';
            }

            // Add review committee info
            message += '### üë• Review Committee\n\n';

            if (scope === 'bank-wide' || type === 'promotion') {
              message += '**Committee:** Expert Architects (@bnc/comite-architectes-experts)\n';
              message += '**Required approvals:** 2\n';
            } else if (scope === 'domaine') {
              const domaineTeam = domaine === 'particuliers' ? 'comite-gov-particuliers' :
                                 domaine === 'entreprises' ? 'comite-gov-entreprises' :
                                 domaine === 'gestion-patrimoine' ? 'comite-gov-patrimoine' :
                                 'comite-gov-[domaine]';
              message += `**Committee:** ${domaine.charAt(0).toUpperCase() + domaine.slice(1)} Governance (@bnc/${domaineTeam})\n`;
              message += '**Required approvals:** 2\n';
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: message
            });

      - name: No PRA files changed
        if: steps.changed-files.outputs.any_changed == 'false'
        run: |
          echo "‚ÑπÔ∏è  No PRA files were changed in this PR"
          echo "Auto-labeling skipped"
